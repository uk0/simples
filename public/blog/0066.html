<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Nginx 做为前端负载均衡时，后端服务器获取的IP为 Nginx 的本机IP，让Nginx 把用户 — NeoJ's Web Page</title>
    <link rel="icon" href="/favicon.ico">
    <link rel="stylesheet" href="/a.css">
    <link rel="stylesheet" href="/pygments.css">
</head>
<body>
<header>
    <nav>
        <table width="620" border="1" class="center">
            <tbody>
            <tr>
                <td width="64" rowspan="2">
                    <img src="/avatar.png" width="64">
                </td>
                <td align="center" colspan="5">
                    <font size="5"><b><font color="#008000">NeoJ</font>'s Web Page</b></font>
                </td>
                <td width="100" align="center" rowspan="2">
                    Last Update:<br>
                </td>
            </tr>
            <tr>
                <td align="center" width="82">
                    <a href="/">Index</a>
                </td>
                <td class="active" align="center" width="82">
                    <a href="/">Blog</a>
                </td>
                <td align="center" width="82">
                    <a href="https://github.com/uk0">Projects</a>
                </td>
                <td align="center" width="82">
                    <a href="https://github.com/uk0">GitHub</a>
                </td>
                <td align="center" width="82">
                    <a href="/about/">About</a>
                </td>
            </tr>
            </tbody>
        </table>
    </nav>
</header>

<div class="page center">
    <h1 class="text_center">Nginx 做为前端负载均衡时，后端服务器获取的IP为 Nginx 的本机IP，让Nginx 把用户</h1>

    <p class="meta text_center">
        
    </p>
    <article>
        <h1>Nginx 做为前端负载均衡时，后端服务器获取的IP为 Nginx 的本机IP，让Nginx 把用户IP传递到后端里面去。</h1>
<h2>问题</h2>
<p>Nginx 做为前端负载均衡时，后端服务器获取的IP为 Nginx 的本机IP.</p>
<h2>解决办法</h2>
<pre><code>1. Nginx 开启 http_realip_module 模块  
  
./configure --with-http_realip_module  
  
make &amp;&amp; make install  
  
  
2. Nginx 前端 增加 proxy_set_header  
  
proxy_set_header X-Real-IP $remote_addr;  
  
  
3. Nginx 后端 增加 real_ip_header  
  
real_ip_header X-Real-IP;  
  
后端配置 必须重启 Nginx 才能生效， reload 不生效。  
  
4. Tomcat 后端 需要修改 Service.xml  
  
找到   
pattern=&quot;%h %l %u %t &amp;quot;%r&amp;quot; %s %b&quot; /&gt;  
  
修改为   
pattern=&quot;%{X-FORWARDED-FOR}i %l %u %t %r %s %b %D %q %{User-Agent}i %T&quot; resolveHosts=&quot;false&quot;/&gt;  
  
</code></pre>

    </article>
</div>

<footer>
    <div class="footer center text_center">
        <p><font size="2">Website is best viewed in 800x600 or higher equivalent resolution.</font></p>
        <hr>
        <p><img src="/CC-BY-SA.png" height="31">&nbsp;<img src="/linuxnow.gif">&nbsp;<img src="/anybrowser.gif"></p>
        <p><font size="2">Copyright © 2015-2025 Jianxin Zhang. All rights reserved.<br>
            Unless otherwise noted, content on this site is licensed under CC BY-SA 4.0.</font></p>
    </div>
</footer>
</body>
</html>