<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Test Nes Game</title>
    <link rel="icon" href="../favicon.ico">


    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.11.1/styles/routeros.min.css">

    <link rel="stylesheet" href="../a.css">
    <meta name="viewport" content="width=device-width, initial-scale=1">
</head>

<body class="win95-bg">

<table class="outer" width="100%" height="100%" border="0" cellspacing="0" cellpadding="0">
    <tr>
        <td align="center" valign="top">
            <table class="frame" width="650" border="0" cellspacing="0" cellpadding="6">
                
                <tr>
                    <td class="avatar-cell" width="64" rowspan="2" align="center">
                        <a href="../index.html">
                            <img class="avatar" src="../avatar.png" width="48" height="48" alt="avatar">
                        </a>
                    </td>
                    <td class="titlebar" align="center">
                        <h2 class="title" style="margin:4px 0;">Test Nes Game</h2>
                        <div class="post-category">Category: blog</div>
                    </td>
                    <td class="infobar" width="160" rowspan="2" align="center">
                        <a href="../index.html">Home</a>
                    </td>
                </tr>
                
                <tr>
                    <td class="nav" align="center">
                        <a href="../index.html">Index</a>
                        <span class="sep">|</span>
                        <a href="../about.html">About</a>
                    </td>
                </tr>

                
                <tr>
                    <td colspan="3">
                        <hr class="hr-etched">
                    </td>
                </tr>

                
                <tr>
                    <td class="content" colspan="3">
                        <div class="post-body"><h1>Test Nes Game</h1>
<ol>
<li>三木童子</li>
</ol>
<div class="nes-player-container" id="nes_f07d3470-container">
  <style>
    #nes_f07d3470-container {
      margin: 20px 0;
      padding: 20px;
      background: #000;
      border-radius: 8px;
      display: inline-block;
      max-width: 100%;
      font-family: Arial, sans-serif;
    }
    #nes_f07d3470-container .nes-header {
      color: #fff;
      margin-bottom: 15px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 10px;
    }
    #nes_f07d3470-container .nes-title {
      font-size: 16px;
      font-weight: bold;
      word-break: break-word;
    }
    #nes_f07d3470-container .nes-controls {
      display: flex;
      gap: 10px;
      margin-bottom: 10px;
      flex-wrap: wrap;
      align-items: center;
    }
    #nes_f07d3470-container button {
      background: #4CAF50;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      transition: background 0.3s;
    }
    #nes_f07d3470-container button:hover:not(:disabled) {
      background: #45a049;
    }
    #nes_f07d3470-container button:disabled {
      background: #666;
      cursor: not-allowed;
      opacity: 0.6;
    }
    #nes_f07d3470-container .canvas-wrapper {
      position: relative;
      display: inline-block;
    }
    #nes_f07d3470-container canvas {
      width: 512px;
      max-width: 100%;
      image-rendering: pixelated;
      image-rendering: -moz-crisp-edges;
      image-rendering: crisp-edges;
      border: 2px solid #333;
      display: block;
      background: #000;
      cursor: pointer;
    }
    #nes_f07d3470-container canvas:fullscreen {
      width: 100%;
      height: 100%;
      object-fit: contain;
    }
    #nes_f07d3470-container .nes-loading {
      color: #fff;
      text-align: center;
      padding: 50px;
    }
    #nes_f07d3470-container .nes-error {
      color: #ff4444;
      padding: 20px;
      background: rgba(255, 68, 68, 0.1);
      border-radius: 4px;
      margin-top: 10px;
    }
    #nes_f07d3470-container .nes-warning {
      color: #ffa500;
      padding: 10px;
      background: rgba(255, 165, 0, 0.1);
      border-radius: 4px;
      margin-top: 10px;
      font-size: 12px;
      text-align: center;
    }
    #nes_f07d3470-container .nes-instructions {
      margin-top: 15px;
      padding: 15px;
      background: rgba(255, 255, 255, 0.05);
      border-radius: 4px;
      color: #fff;
      font-size: 13px;
      line-height: 1.8;
    }
    #nes_f07d3470-container .nes-instructions h4 {
      margin: 0 0 10px 0;
      color: #4CAF50;
      font-size: 14px;
    }
    #nes_f07d3470-container .key-mapping {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 15px;
      margin-top: 10px;
    }
    #nes_f07d3470-container .key-group {
      padding: 10px;
      background: rgba(0, 0, 0, 0.3);
      border-radius: 4px;
    }
    #nes_f07d3470-container .key-group-title {
      color: #4CAF50;
      font-weight: bold;
      margin-bottom: 8px;
      font-size: 13px;
      text-align: center;
    }
    #nes_f07d3470-container .key-item {
      display: flex;
      justify-content: space-between;
      padding: 3px 0;
      font-size: 12px;
      color: #aaa;
      align-items: center;
    }
    #nes_f07d3470-container .key-item .action {
      color: #fff;
    }
    #nes_f07d3470-container .key-item .key {
      color: #4CAF50;
      font-family: monospace;
      background: rgba(76, 175, 80, 0.2);
      padding: 2px 6px;
      border-radius: 3px;
      font-weight: bold;
      text-transform: uppercase;
    }
    #nes_f07d3470-container .nes-info {
      color: #888;
      font-size: 11px;
      margin-top: 5px;
    }
    #nes_f07d3470-container .focus-hint {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(0, 0, 0, 0.8);
      color: #4CAF50;
      padding: 10px 20px;
      border-radius: 4px;
      pointer-events: none;
      opacity: 0;
      transition: opacity 0.3s;
      z-index: 10;
    }
    #nes_f07d3470-container .canvas-wrapper:hover .focus-hint.show {
      opacity: 1;
    }
    @media (max-width: 600px) {
      #nes_f07d3470-container canvas {
        width: 100%;
      }
      #nes_f07d3470-container .key-mapping {
        grid-template-columns: 1fr;
      }
    }
  </style>
  <div class="nes-header">
    <div class="nes-title">🎮 smtz.nes</div>
    <a href="0101/attachments/F0A9D99A.dat" download style="color: #4CAF50; text-decoration: none; font-size: 14px;">⬇ Download ROM</a>
  </div>
  <div id="nes_f07d3470-loading" class="nes-loading">
    <div>Loading NES emulator...</div>
  </div>
  <div id="nes_f07d3470-player" style="display: none;">
    <div class="nes-controls">
      <button id="nes_f07d3470-pause">⏸ Pause</button>
      <button id="nes_f07d3470-resume" style="display: none;">▶ Resume</button>
      <button id="nes_f07d3470-reset">🔄 Reset</button>
      <button id="nes_f07d3470-fullscreen">⛶ Fullscreen</button>
      <button id="nes_f07d3470-mute">🔇 Mute</button>
    </div>
    <div class="canvas-wrapper">
      <canvas id="nes_f07d3470-canvas" width="256" height="240" tabindex="0"></canvas>
      <div class="focus-hint" id="nes_f07d3470-focus-hint">Click to focus</div>
    </div>
    <div class="nes-warning">
      ⚠️ 请关闭与相关键位冲突的浏览器插件或快捷键 (如 Vimium, Surfingkeys 等)
    </div>
    <div class="nes-instructions">
      <h4>🎮 键盘控制</h4>
      <div class="key-mapping">
        <div class="key-group">
          <div class="key-group-title">方向控制</div>
          <div class="key-item">
            <span class="action">上</span>
            <span class="key">W</span>
          </div>
          <div class="key-item">
            <span class="action">下</span>
            <span class="key">S</span>
          </div>
          <div class="key-item">
            <span class="action">左</span>
            <span class="key">A</span>
          </div>
          <div class="key-item">
            <span class="action">右</span>
            <span class="key">D</span>
          </div>
        </div>
        <div class="key-group">
          <div class="key-group-title">动作按钮</div>
          <div class="key-item">
            <span class="action">A 按钮</span>
            <span class="key">K</span>
          </div>
          <div class="key-item">
            <span class="action">B 按钮</span>
            <span class="key">L</span>
          </div>
          <div class="key-item">
            <span class="action">选择 (Select)</span>
            <span class="key">I</span>
          </div>
          <div class="key-item">
            <span class="action">开始 (Start)</span>
            <span class="key">O</span>
          </div>
        </div>
      </div>
    </div>
    <div id="nes_f07d3470-info" class="nes-info"></div>
  </div>
  <div id="nes_f07d3470-error" class="nes-error" style="display: none;"></div>
  <script>
  (function() {
    'use strict';
    
    // Configuration
    const PLAYER_ID = 'nes_f07d3470';
    const ROM_PATH = '0101/attachments/F0A9D99A.dat';
    
    // Constants from official example
    var SCREEN_WIDTH = 256;
    var SCREEN_HEIGHT = 240;
    var FRAMEBUFFER_SIZE = SCREEN_WIDTH * SCREEN_HEIGHT;
    
    var canvas_ctx, image;
    var framebuffer_u8, framebuffer_u32;
    
    var AUDIO_BUFFERING = 512;
    var SAMPLE_COUNT = 4 * 1024;
    var SAMPLE_MASK = SAMPLE_COUNT - 1;
    var audio_samples_L = new Float32Array(SAMPLE_COUNT);
    var audio_samples_R = new Float32Array(SAMPLE_COUNT);
    var audio_write_cursor = 0, audio_read_cursor = 0;
    
    var nes = null;
    var running = false;
    var paused = false;
    var muted = false;
    var audio_ctx = null;
    var script_processor = null;
    var romData = null;
    var canvasHasFocus = false;
    
    // Frame timing control
    var frameTime = 0;
    var lastFrameTime = 0;
    var targetFrameTime = 1000 / 60; // 60 FPS for NTSC
    
    // DOM elements
    const elements = {
      container: document.getElementById(PLAYER_ID + '-container'),
      loading: document.getElementById(PLAYER_ID + '-loading'),
      player: document.getElementById(PLAYER_ID + '-player'),
      error: document.getElementById(PLAYER_ID + '-error'),
      info: document.getElementById(PLAYER_ID + '-info'),
      canvas: document.getElementById(PLAYER_ID + '-canvas'),
      focusHint: document.getElementById(PLAYER_ID + '-focus-hint'),
      pauseBtn: document.getElementById(PLAYER_ID + '-pause'),
      resumeBtn: document.getElementById(PLAYER_ID + '-resume'),
      resetBtn: document.getElementById(PLAYER_ID + '-reset'),
      fullscreenBtn: document.getElementById(PLAYER_ID + '-fullscreen'),
      muteBtn: document.getElementById(PLAYER_ID + '-mute')
    };
    
    // Show error
    function showError(message) {
      console.error('[NES Player]', message);
      if (elements.error) {
        elements.error.textContent = message;
        elements.error.style.display = 'block';
      }
      if (elements.loading) {
        elements.loading.style.display = 'none';
      }
    }
    
    // Frame-limited animation loop
    function onAnimationFrame(currentTime) {
      if (!running || paused) return;
      
      window.requestAnimationFrame(onAnimationFrame);
      
      // Calculate time since last frame
      if (!lastFrameTime) lastFrameTime = currentTime;
      frameTime = currentTime - lastFrameTime;
      
      // Only run frame if enough time has passed (frame limiting)
      if (frameTime >= targetFrameTime) {
        image.data.set(framebuffer_u8);
        canvas_ctx.putImageData(image, 0, 0);
        
        // Don't run extra frames here - let audio callback handle timing
        lastFrameTime = currentTime - (frameTime % targetFrameTime);
      }
    }
    
    // Audio functions from official example
    function audio_remain() {
      return (audio_write_cursor - audio_read_cursor) & SAMPLE_MASK;
    }
    
    function audio_callback(event) {
      if (muted) {
        var dst = event.outputBuffer;
        var len = dst.length;
        var dst_l = dst.getChannelData(0);
        var dst_r = dst.getChannelData(1);
        for (var i = 0; i < len; i++) {
          dst_l[i] = 0;
          dst_r[i] = 0;
        }
        return;
      }
      
      var dst = event.outputBuffer;
      var len = dst.length;
      
      // Attempt to avoid buffer underruns - this drives the frame timing
      if (audio_remain() < AUDIO_BUFFERING && running && !paused) {
        nes.frame();
      }
      
      var dst_l = dst.getChannelData(0);
      var dst_r = dst.getChannelData(1);
      for (var i = 0; i < len; i++) {
        var src_idx = (audio_read_cursor + i) & SAMPLE_MASK;
        dst_l[i] = audio_samples_L[src_idx];
        dst_r[i] = audio_samples_R[src_idx];
      }
      
      audio_read_cursor = (audio_read_cursor + len) & SAMPLE_MASK;
    }
    
    // New keyboard handler with WASD + IOKL mapping
    function keyboard(callback, event) {
      var player = 1;
      var handled = true;
      
      // Convert to uppercase for consistent checking
      var key = event.key ? event.key.toUpperCase() : '';
      var keyCode = event.keyCode;
      
      // WASD for directions
      if (key === 'W' || keyCode === 87) {
        callback(player, jsnes.Controller.BUTTON_UP);
      } else if (key === 'S' || keyCode === 83) {
        callback(player, jsnes.Controller.BUTTON_DOWN);
      } else if (key === 'A' || keyCode === 65) {
        callback(player, jsnes.Controller.BUTTON_LEFT);
      } else if (key === 'D' || keyCode === 68) {
        callback(player, jsnes.Controller.BUTTON_RIGHT);
      }
      // IOKL for buttons
      else if (key === 'K' || keyCode === 75) {
        callback(player, jsnes.Controller.BUTTON_A);
      } else if (key === 'L' || keyCode === 76) {
        callback(player, jsnes.Controller.BUTTON_B);
      } else if (key === 'I' || keyCode === 73) {
        callback(player, jsnes.Controller.BUTTON_SELECT);
      } else if (key === 'O' || keyCode === 79) {
        callback(player, jsnes.Controller.BUTTON_START);
      } else {
        handled = false;
      }
      
      if (handled) {
        event.preventDefault();
      }
    }
    
    // Initialize NES (based on official nes_init)
    function nes_init(canvas_id) {
      var canvas = document.getElementById(canvas_id);
      canvas_ctx = canvas.getContext("2d");
      image = canvas_ctx.getImageData(0, 0, SCREEN_WIDTH, SCREEN_HEIGHT);
      
      canvas_ctx.fillStyle = "black";
      canvas_ctx.fillRect(0, 0, SCREEN_WIDTH, SCREEN_HEIGHT);
      
      // Allocate framebuffer array
      var buffer = new ArrayBuffer(image.data.length);
      framebuffer_u8 = new Uint8ClampedArray(buffer);
      framebuffer_u32 = new Uint32Array(buffer);
      
      // Setup audio
      try {
        audio_ctx = new (window.AudioContext || window.webkitAudioContext)();
        
        // Make sure sample rate is correct
        var sampleRate = audio_ctx.sampleRate;
        console.log('Audio context sample rate:', sampleRate);
        
        script_processor = audio_ctx.createScriptProcessor(AUDIO_BUFFERING, 0, 2);
        script_processor.onaudioprocess = audio_callback;
        script_processor.connect(audio_ctx.destination);
      } catch (e) {
        console.warn('Audio setup failed:', e);
      }
      
      // Create NES instance with proper sample rate
      nes = new jsnes.NES({
        onFrame: function(framebuffer_24) {
          for (var i = 0; i < FRAMEBUFFER_SIZE; i++) {
            framebuffer_u32[i] = 0xFF000000 | framebuffer_24[i];
          }
        },
        onAudioSample: function(l, r) {
          audio_samples_L[audio_write_cursor] = l;
          audio_samples_R[audio_write_cursor] = r;
          audio_write_cursor = (audio_write_cursor + 1) & SAMPLE_MASK;
        },
        sampleRate: audio_ctx ? audio_ctx.sampleRate : 44100
      });
      
      // Setup keyboard - only respond when canvas has focus
      document.addEventListener('keydown', function(event) {
        if (running && !paused && canvasHasFocus) {
          keyboard(nes.buttonDown, event);
        }
      });
      
      document.addEventListener('keyup', function(event) {
        if (running && !paused && canvasHasFocus) {
          keyboard(nes.buttonUp, event);
        }
      });
      
      // Canvas focus management
      canvas.addEventListener('focus', function() {
        canvasHasFocus = true;
        elements.focusHint.classList.remove('show');
      });
      
      canvas.addEventListener('blur', function() {
        canvasHasFocus = false;
      });
      
      canvas.addEventListener('click', function() {
        this.focus();
        // Resume audio context on user interaction
        if (audio_ctx && audio_ctx.state === 'suspended') {
          audio_ctx.resume();
        }
      });
      
      // Show focus hint when hovering over unfocused canvas
      canvas.addEventListener('mouseenter', function() {
        if (!canvasHasFocus) {
          elements.focusHint.classList.add('show');
        }
      });
      
      canvas.addEventListener('mouseleave', function() {
        elements.focusHint.classList.remove('show');
      });
    }
    
    // Boot the NES with ROM data (based on official nes_boot)
    function nes_boot(rom_data_string) {
      try {
        // Store the ROM data for reset functionality
        romData = rom_data_string;
        
        nes.loadROM(rom_data_string);
        
        // Display ROM info
        if (elements.info && rom_data_string.length > 16) {
          var header = new Uint8Array(rom_data_string.length);
          for (var i = 0; i < rom_data_string.length; i++) {
            header[i] = rom_data_string.charCodeAt(i) & 0xFF;
          }
          
          if (header[0] === 0x4E && header[1] === 0x45 && header[2] === 0x53) {
            var prg = header[4] * 16;
            var chr = header[5] * 8;
            var mapper = ((header[7] & 0xF0) | ((header[6] & 0xF0) >> 4));
            elements.info.textContent = 'Mapper: ' + mapper + ' | PRG: ' + prg + 'KB | CHR: ' + chr + 'KB | 点击画面获取键盘焦点';
          }
        }
        
        elements.loading.style.display = 'none';
        elements.player.style.display = 'block';
        
        running = true;
        
        // Auto-focus canvas for immediate play
        elements.canvas.focus();
        
        // Start animation loop with proper timing
        window.requestAnimationFrame(onAnimationFrame);
        
        // Setup controls
        setupControls();
        
        console.log('NES emulator started successfully');
      } catch (e) {
        showError('Failed to load ROM: ' + e.message);
        console.error('ROM loading error:', e);
      }
    }
    
    // Load ROM from URL (based on official nes_load_url)
    function nes_load_url(canvas_id, path) {
      nes_init(canvas_id);
      
      var req = new XMLHttpRequest();
      req.open("GET", path);
      req.overrideMimeType("text/plain; charset=x-user-defined");
      req.onerror = function() {
        showError('Error loading ROM: ' + req.statusText);
      };
      
      req.onload = function() {
        if (this.status === 200) {
          console.log('ROM loaded, size:', this.responseText.length, 'bytes');
          nes_boot(this.responseText);
        } else if (this.status === 0) {
          // Aborted, so ignore error
        } else {
          req.onerror();
        }
      };
      
      req.send();
    }
    
    // Setup control buttons
    function setupControls() {
      elements.pauseBtn.onclick = function() {
        paused = true;
        this.style.display = 'none';
        elements.resumeBtn.style.display = 'inline-block';
      };
      
      elements.resumeBtn.onclick = function() {
        paused = false;
        lastFrameTime = 0; // Reset frame timing
        this.style.display = 'none';
        elements.pauseBtn.style.display = 'inline-block';
        
        // Resume animation if it was stopped
        if (running) {
          window.requestAnimationFrame(onAnimationFrame);
        }
        
        // Resume audio context
        if (audio_ctx && audio_ctx.state === 'suspended') {
          audio_ctx.resume();
        }
      };
      
      // Fixed reset button - use nes.reset() instead of nes.stop()
      elements.resetBtn.onclick = function() {
        if (nes && romData) {
          try {
            // Reset the NES
            nes.reset();
            
            // Reset audio buffers
            audio_write_cursor = 0;
            audio_read_cursor = 0;
            for (var i = 0; i < SAMPLE_COUNT; i++) {
              audio_samples_L[i] = 0;
              audio_samples_R[i] = 0;
            }
            
            // Reset frame timing
            lastFrameTime = 0;
            
            // Ensure not paused
            paused = false;
            elements.resumeBtn.style.display = 'none';
            elements.pauseBtn.style.display = 'inline-block';
            
            // Restart animation if needed
            if (!running) {
              running = true;
              window.requestAnimationFrame(onAnimationFrame);
            }
            
            console.log('NES reset successfully');
          } catch (e) {
            console.error('Reset error:', e);
          }
        }
      };
      
      // Fullscreen button
      elements.fullscreenBtn.onclick = function() {
        var canvas = elements.canvas;
        
        if (!document.fullscreenElement && 
            !document.mozFullScreenElement && 
            !document.webkitFullscreenElement && 
            !document.msFullscreenElement) {
          // Enter fullscreen
          if (canvas.requestFullscreen) {
            canvas.requestFullscreen();
          } else if (canvas.mozRequestFullScreen) {
            canvas.mozRequestFullScreen();
          } else if (canvas.webkitRequestFullscreen) {
            canvas.webkitRequestFullscreen();
          } else if (canvas.msRequestFullscreen) {
            canvas.msRequestFullscreen();
          }
        } else {
          // Exit fullscreen
          if (document.exitFullscreen) {
            document.exitFullscreen();
          } else if (document.mozCancelFullScreen) {
            document.mozCancelFullScreen();
          } else if (document.webkitExitFullscreen) {
            document.webkitExitFullscreen();
          } else if (document.msExitFullscreen) {
            document.msExitFullscreen();
          }
        }
      };
      
      elements.muteBtn.onclick = function() {
        muted = !muted;
        this.textContent = muted ? '🔊 Unmute' : '🔇 Mute';
      };
    }
    
    // Load JSNES library
    function loadJSNES() {
      if (window.jsnes && window.jsnes.NES) {
        console.log('JSNES already loaded');
        nes_load_url(PLAYER_ID + '-canvas', ROM_PATH);
        return;
      }
      
      // Check if already loading
      var existingScript = document.querySelector('script[data-jsnes="true"]');
      if (existingScript) {
        console.log('JSNES script already loading');
        existingScript.addEventListener('load', function() {
          nes_load_url(PLAYER_ID + '-canvas', ROM_PATH);
        });
        return;
      }
      
      // Load JSNES
      console.log('Loading JSNES library...');
      var script = document.createElement('script');
      script.src = 'https://unpkg.com/jsnes/dist/jsnes.min.js';
      script.setAttribute('data-jsnes', 'true');
      script.onload = function() {
        console.log('JSNES loaded successfully');
        nes_load_url(PLAYER_ID + '-canvas', ROM_PATH);
      };
      script.onerror = function() {
        showError('Failed to load JSNES library. Please check your internet connection.');
      };
      document.head.appendChild(script);
    }
    
    // Cleanup
    window.addEventListener('beforeunload', function() {
      running = false;
      if (audio_ctx) {
        audio_ctx.close();
      }
    });
    
    // Start loading
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', loadJSNES);
    } else {
      loadJSNES();
    }
  })();
  </script>
</div>  
</div>
                    </td>
                </tr>

                
                <tr>
                    <td colspan="3" align="right" style="font-size:small;">
                        <a href="#">↑ Back to top</a>
                    </td>
                </tr>
            </table>
        </td>
    </tr>

    
    <tr>
        <td align="center" valign="bottom" height="60">
            <font size="-1">
                <a href="../index.html">Back to Home</a>
            </font>
        </td>
    </tr>
</table>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.11.1/highlight.min.js"></script>




<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.11.1/languages/python.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.11.1/languages/bash.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.11.1/languages/shell.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.11.1/languages/javascript.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.11.1/languages/css.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlightjs-line-numbers.js/2.8.0/highlightjs-line-numbers.min.js"></script>
<script>

    if (document.readyState === "loading") {
        
        document.addEventListener("DOMContentLoaded", function() {
            hljs.highlightAll();
            hljs.initLineNumbersOnLoad();
        });
    } else {
        
        hljs.highlightAll();
        hljs.initLineNumbersOnLoad();
    }


</script>
</body>
</html>