<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RocketMQ消息队列安装以及使用[原创精品]</title>
    <meta name="description" content="笔记">
    <meta name="keywords" content="RocketMQ">
    <style>
        body {
            font-family: sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f5f5f5;
            color: #333;
            transition: background-color 0.3s ease;
            max-width: 820px;
            margin: 0 auto;
        }

        .container {
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            background-color: #fff;
        }

        h1 {
            font-size: 20px;
        }

        h2 {
            font-size: 18px;
        }

        h3 {
            font-size: 16px;
        }

        h4 {
            font-size: 14px;
        }

        h5 {
            font-size: 12px;
        }

        h6 {
            font-size: 11px;
        }

        pre {
            background-color: #f0f0f0;
            padding: 10px;
            border-radius: 5px;
            overflow-x: auto;
        }

        code {
            font-family: monospace;
        }

        .highlight {
            background-color: #f0f0f0;
            padding: 10px;
            border-radius: 5px;
            overflow-x: auto;
        }

        footer {
            text-align: center;
            margin-top: 20px;
            padding: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 style="text-align: center;">RocketMQ消息队列安装以及使用[原创精品]</h1>
        <h2 style="text-align: center;">摘要: 我要装个RocketMQ</h2>
        <h3 style="text-align: center;"># rocketmq 安装</h3>
        <p>安装rocketmq需要环境：</p>
        <ul>
            <li>jdk1.7以上</li>
            <li>maven</li>
            <li>git</li>
        </ul>
        <p>*jdk1.8*</p>
        <pre>
            wget http://112firshme11224.test.upcdn.net/blog/tmp/jdk-8u92-linux-x64.tar.gz
        </pre>
        <p>*maven下载：*</p>
        <pre>
            wget http://mirrors.hust.edu.cn/apache/maven/maven-3/3.3.9/binaries/apache-maven-3.3.9-bin.tar.gz

            tar xf apache-maven-3.3.9-bin.tar.gz -C /opt/
        </pre>
        <p>*git下载：*</p>
        <pre>
            yum install git -y

        </pre>
        <p>*环境变量如下：*</p>
        <pre>
            export PATH USER LOGNAME MAIL HOSTNAME HISTSIZE HISTCONTROL
            export JAVA_HOME=/opt/jdk/jdk1.8.0_65
            export JRE_HOME=/opt/jdk/jdk1.8.0_65/jre
            export CLASSPATH=.:$JAVA_HOME/lib/dt.jar:$JAVA_HOME/lib/tools.jar:$JRE_HOME/lib:$CLASSPATH
            export PATH=$PATH:$JAVA_HOME/bin/
            export PATH=$PATH:/usr/local/go/bin
            export GOPATH=/usr/local/
            export M2_HOME=/opt/apache-maven-3.3.9
            export PATH=$PATH:$M2_HOME/bin
            export ROCKETMQ_HOME=/opt/RocketMQ-3.5.8/devenv
            export NAMESRV_ADDR=127.0.0.1:9876
        </pre>
        <p>*使配置文件生效*</p>
        <pre>
            source /etc/profile
        </pre>
        <p>*检测maven*</p>
        <pre>
            [root@dscn1 ~]# mvn -v
            Apache Maven 3.3.9 (bb52d8502b132ec0a5a3f4c09453c07478323dc5; 2015-11-11T00:41:47+08:00)
            Maven home: /opt/apache-maven-3.3.9
            Java version: 1.8.0_65, vendor: Oracle Corporation
            Java home: /opt/jdk/jdk1.8.0_65/jre
            Default locale: zh_CN, platform encoding: UTF-8
            OS name: "linux", version: "2.6.32-573.22.1.el6.x86_64", arch: "amd64", family: "unix"
        </pre>
        <h3 id="toc">一、正式开始安装rocketmq</h3>
        <p>1、下载安装</p>
        <pre>
            a）wget https://github.com/alibaba/RocketMQ/archive/v3.5.8.tar.gz		###下载包
            b）tar -xf v3.5.8.tar.gz	 -C /opt/	###解压
            c）cd /opt/RocketMQ-3.5.8 	###进入解压后目录
            d）sh install.sh			###进行安装(下载国外的数据，时间较长)
        </pre>
        <p>2、修改文件内存</p>
        <pre>
            cd /opt/RocketMQ-3.5.8/devenv/bin
            #vim修改runbroker.sh、runserver.sh两个文件
            -------------------------------------
            JAVA_OPT="${JAVA_OPT} -server -Xms512m -Xmx512m -Xmn256m -XX:PermSize=128m -XX:MaxPermSize=320m"		###Xms启动时内存，Xmx最大内存，Xmn最小内存
            --------------------------------------
        </pre>
        <p>3、启动<code>nameserver</code></p>
        <pre>
            nohup sh  mqnamesrv >/var/log/ns.log 2>&1 &
        </pre>
        <p>4、验证<code>nameserver</code>是否启动：</p>
        <pre>
            tail -f /var/log/ns.log   ###查看日志有无错误信息
        </pre>
        <p>5、启动<code>broker</code>
        在启动<code>borker</code>之前需要指定<code>nameserver</code>地址：</p>
        <pre>
            echo "export NAMESRV_ADDR=127.0.0.1:9876" >> /etc/profile		###写入到环境变量，或者直接
            -n来指定
            nohup sh mqbroker -n 192.168.0.106:9876 autoCreateTopicEnable=true > /var/log/mq.log 2>&1 &
        </pre>
        <p>6、检验是否开启</p>
        <pre>
            tail -f /var/log/mq.log   ###查看日志有无错误信息
        </pre>
        <p>7、关闭的命令：</p>
        <pre>
            sh mqshutdown namesrv
            sh mqshutdown broker
        </pre>
        <p>8、创建队列</p>
        <pre>
            sh mqadmin updateTopic -b "192.168.0.106:10911" -t Topic1 -r 10 -w 10			###-b   broker的ip和端口	-t java程序中定义的名字
        </pre>
        <p>9、更改broker配置文件，更改ip,使外网可以访问</p>
        <pre>
            sh mqadmin updateBrokerConfig -b 192.168.0.106:10911 -k brokerIP1 -v 192.168.0.106
        </pre>
        <p>10、以此输入下面两个命令：</p>
        <pre>
            bash tools.sh com.alibaba.rocketmq.example.quickstart.Producer		###生产者(生产队列)

            bash tools.sh com.alibaba.rocketmq.example.quickstart.Consumer		###消费者（清理队列）
        </pre>
        <p>
        >如果报错是内存不够，就改<code>runbroker.sh</code>、<code>runserver.sh</code>两个文件
        >
        >如果启动报错是不知道主机：
        >检查/etc/sysconfig/network 中的记录的hostname是否和/etc/hosts中的主机名绑定一致，如果不一致请确保一致
        >在/etc/hosts中添加 192.168.1.118 hostname的名称(master01)跟/etc/sysconfig/network一样(master01)
        >
        >开启9876rocketmq的nameserver端口  #vim /etc/sysconfig/iptables
        </p>
        <h3 id="toc">二、一主一从的配置</h3>
        <p>除了启动步骤不同。其余与上面一主的配置相同：</p>
        <p>1、修改/opt/RocketMQ-3.5.8/devenv/bin/runbroker.sh、runserver.sh两个文件：</p>
        <pre>
            JAVA_OPT="${JAVA_OPT} -server -Xms512m -Xmx512m -Xmn256m -XX:PermSize=128m -XX:MaxPermSize=320m"		###Xms启动时内存，Xmx最大内存，Xmn最小内存
        </pre>
        <p>2、主的机器修改/opt/RocketMQ-3.5.8/devenv/conf/2m-2s-async/broker-a.properties</p>
        <pre>
            namesrvAddr=192.168.0.106:9876;192.168.0.107:9876
            brokerIP1=192.168.0.106
            brokerClusterName=DefaultCluster
            brokerName=broker-a
            brokerId=0
            deleteWhen=04
            fileReservedTime=48
            brokerRole=ASYNC_MASTER
            flushDiskType=ASYNC_FLUSH
            storePathRootDir=/opt/RocketMQ-3.4.6
            storePathCommitLog=/opt/RocketMQ-3.4.6/log/commitlog
        </pre>
        <p>3、从的机器修改/opt/RocketMQ-3.5.8/devenv/conf/2m-2s-async/broker-a-s.properties</p>
        <pre>
            namesrvAddr=192.168.0.106:9876;192.168.0.107:9876
            brokerIP1=192.168.0.107
            brokerClusterName=DefaultCluster
            brokerName=broker-a
            brokerId=1
            deleteWhen=04
            fileReservedTime=48
            brokerRole=SLAVE
            flushDiskType=ASYNC_FLUSH
            storePathRootDir=/opt/RocketMQ-3.4.6
            storePathCommitLog=/opt/RocketMQ-3.4.6/log/commitlog
        </pre>
        <p>
        >参考内容和解释如下：
        </p>
        <pre>
            #所属集群名字
            brokerClusterName=rocketmq-cluster
            #broker名字，注意此处不同的配置文件填写的不一样
            brokerName=broker-a|broker-b
            #0 表示 Master， >0 表示 Slave
            brokerId=0
            #nameServer地址，分号分割
            namesrvAddr=rocketmq-nameserver1:9876;rocketmq-nameserver2:9876
            #在发送消息时，自动创建服务器不存在的topic，默认创建的队列数
            defaultTopicQueueNums=4
            #是否允许 Broker 自动创建Topic，建议线下开启，线上关闭
            autoCreateTopicEnable=true
            #是否允许 Broker 自动创建订阅组，建议线下开启，线上关闭
            autoCreateSubscriptionGroup=true
            #Broker 对外服务的监听端口
            listenPort=10911
            #删除文件时间点，默认凌晨 0点
            deleteWhen=00
            #文件保留时间，默认 48 小时
            fileReservedTime=120
            #commitLog每个文件的大小默认1G
            mapedFileSizeCommitLog=1073741824
            #ConsumeQueue每个文件默认存30W条，根据业务情况调整
            mapedFileSizeConsumeQueue=300000
            #destroyMapedFileIntervalForcibly=120000
            #redeleteHangedFileInterval=120000
            #检测物理文件磁盘空间
            diskMaxUsedSpaceRatio=88
            #存储路径
            storePathRootDir=/opt/rocketmq/data
            #commitLog 存储路径
            storePathCommitLog=/opt/rocketmq/data/commitlog
            #消费队列存储路径存储路径
            storePathConsumeQueue=/opt/rocketmq/data/consumequeue
            #消息索引存储路径
            storePathIndex=/opt/rocketmq/data/index
            #checkpoint 文件存储路径
            storeCheckpoint=/opt/rocketmq/data/checkpoint
            #abort 文件存储路径
            abortFile=/opt/rocketmq/data/abort
            #限制的消息大小
            maxMessageSize=65536
            #flushCommitLogLeastPages=4
            #flushConsumeQueueLeastPages=2
            #flushCommitLogThoroughInterval=10000
            #flushConsumeQueueThoroughInterval=60000
            #Broker 的角色
            #- ASYNC_MASTER 异步复制Master
            #- SYNC_MASTER 同步双写Master
            #- SLAVE
            brokerRole=ASYNC_MASTER
            #刷盘方式
            #- ASYNC_FLUSH 异步刷盘
            #- SYNC_FLUSH 同步刷盘
            flushDiskType=ASYNC_FLUSH
            #checkTransactionMessageEnable=false
            #发消息线程池数量
            #sendMessageThreadPoolNums=128
            #拉消息线程池数量
            #pullMessageThreadPoolNums=128
        </pre>
        <p>4、两个机器上都启动nameserver:</p>
        <pre>
            nohup sh  mqnamesrv >/var/log/ns.log 2>&1 &
        </pre>
        <p>5、主的机器启动broker：</p>
        <pre>
            nohup sh mqbroker -c ../conf/2m-2s-async/broker-a.properties > /var/log/mq.log 2>&1 &
        </pre>
        <p>6、从的机器启动broker：</p>
        <pre>
            nohup sh mqbroker -c ../conf/2m-2s-async/broker-a-s.properties > /var/log/mq.log 2>&1 &
        </pre>
        <h3 id="toc">运行成功的图！</h3>
        <p><img src="http://112firshme11224.test.upcdn.net/blog/tmp/rocketmq-p.png"></p>
        <p><img src="http://112firshme11224.test.upcdn.net/blog/tmp/rocketmq-c.png"></p>
        <h3 id="toc">禁止转载，盗版必究。</h3>
        <p><a href="https://juejin.im/post/5a31e9c5f265da431d3cb134"><img src="https://badge.juejin.im/entry/5a31ea02f265da4319564878/likes.svg?style=plastic"></a></p>
    </div>
    <footer>
        Power By Gemini TextGenerate 2024-09-16
    </footer>
    <script>
        // 使用随机种子生成随机背景颜色
        const randomSeed = 199602051111;
        Math.seedrandom(randomSeed);
        const randomColor = () => {
            const letters = '0123456789ABCDEF';
            let color = '#';
            for (let i = 0; i < 6; i++) {
                color += letters[Math.floor(Math.random() * 16)];
            }
            return color;
        };

        // 获取当前时间并判断是白天还是黑夜
        const currentTime = new Date();
        const isDaytime = currentTime.getHours() >= 6 && currentTime.getHours() < 18;

        // 设置背景颜色
        document.body.style.backgroundColor = isDaytime ? randomColor() : '#222';

        // 使用 Highlight.js 或 Prism.js 高亮代码
        const codeBlocks = document.querySelectorAll('pre code');
        codeBlocks.forEach(codeBlock => {
            // 假设你已经包含了 Highlight.js 或 Prism.js 的库文件
            // 在这里使用 Highlight.js 或 Prism.js 渲染代码
            // 例如：hljs.highlightBlock(codeBlock); 或 Prism.highlightElement(codeBlock);
        });
    </script>
</body>
</html>