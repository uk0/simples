<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Flink的自定义Source 如何给重写的open方法传递参数.</title>
<meta name="description" content="笔记" />
<meta name="keywords" content="flink,rocektmq" />
<style>
body {
  background-color: #f4f4f4;
  color: #333;
  font-family: sans-serif;
  max-width: 820px;
  margin: 0 auto;
  padding: 20px;
  box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
}

h1, h2, h3, h4, h5, h6 {
  font-weight: normal;
}

h1 {
  font-size: 20px;
}

h2 {
  font-size: 18px;
}

h3 {
  font-size: 16px;
}

h4 {
  font-size: 14px;
}

h5 {
  font-size: 12px;
}

h6 {
  font-size: 11px;
}

pre {
  background-color: #f0f0f0;
  border-radius: 5px;
  padding: 10px;
  overflow-x: auto;
}

code {
  font-family: monospace;
  background-color: #eee;
  padding: 2px 4px;
  border-radius: 3px;
}

footer {
  text-align: center;
  margin-top: 20px;
}
</style>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
<script>hljs.initHighlightingOnLoad();</script>
</head>
<body>
<h1 style="text-align: center;">Flink的自定义Source 如何给重写的open方法传递参数.</h1>
<p style="text-align: center;">笔记</p>
<p style="text-align: center;">flink,rocektmq</p>
<hr>

<p>因工作需求所整合Flink + RocketMQ,中间遇到许多问题本文章将问题解决。</p>

<h2>部分代码：</h2>
<ul>
<li>Flink程序入口</li>
<li>继承RichSinkFunction，重写<code>open</code> 和 <code>invoke</code>方法，还有<code>close</code>。</li>
</ul>

<pre><code class="java">
 final ParameterTool parameterTool = ParameterTool.fromArgs(args);
        if (parameterTool.getNumberOfParameters() < 3) {
                System.out.println("Missing parameters!");
                System.out.println("\nUsage: RocketMQ \n" +
                        "--topic <topic> \n" +
                        "--cgroup <consumerGroupName> \n" +
                        "--conf <consumerGroupName> \n" +
                        "--hdfs <hdfs path>\n"
                );
                return;
        }
            env.getConfig().enableSysoutLogging();
            env.getConfig().setRestartStrategy(RestartStrategies
                    .fixedDelayRestart(4, 100));
            env.enableCheckpointing(5000);
            env.setMaxParallelism(72);
               /**创建 Configuration 对象**/
            Configuration conf = new Configuration();
            conf.setString("topic",parameterTool.get("topic"));
            conf.setString("cgroup",parameterTool.get("cgroup"));
            conf.setString("conf",parameterTool.get("conf"));
            conf.setString("hdfs",parameterTool.get("hdfs"));
            /**将Configuration存入数据，放入全局执行环境内*/
            env.getConfig().setGlobalJobParameters(conf);
            RocketMQSource rocketMQSource = new RocketMQSource();
            DataStream<String> sourceStream = env.addSource(rocketMQSource);
</code></pre>

<h2>Source [重点]</h2>
<ul>
<li>自定义Source的一部分代码</li>
</ul>

<pre><code class="java">
 @Override
    public void open(Configuration parameters) throws Exception {
        super.open(parameters);
        /**获取运行环境内的参数**/
        ExecutionConfig.GlobalJobParameters globalParams = getRuntimeContext().getExecutionConfig().getGlobalJobParameters();
        /**执行参数提取**/
        Configuration globConf = (Configuration) globalParams;
        queue = new LinkedBlockingQueue<>(1000);
        MQConfig.getInstance(globConf.getString("conf",null));
        /**拿到存入参数，并且设置默认值**/
        consumer = new DefaultMQPushConsumer( globConf.getString("cgroup", null));
        consumer.setNamesrvAddr( MQConfig.getMQ());
        consumer.setInstanceName(UUID.randomUUID().toString());
        consumer.setMessageModel(MessageModel.CLUSTERING);// 消费模式
        consumer.setConsumeFromWhere(ConsumeFromWhere.CONSUME_FROM_FIRST_OFFSET);
        consumer.registerMessageListener(this);
        consumer.subscribe(globConf.getString("topic", null), "*");
        consumer.setConsumeThreadMax(64);
        consumer.setConsumeThreadMin(8);
        consumer.setConsumeMessageBatchMaxSize(8);//消息数量每次读取的消息数量
        System.out.println("启动线程");
        consumer.start();
        System.out.println("RocketMQ Started.");
        LOG.info("consumeBatchSize:{} pullBatchSize:{} consumeThread:{}",consumer.getConsumeMessageBatchMaxSize(),consumer.getPullBatchSize(),consumer.getConsumeThreadMax());
    }
</code></pre>

<p>以上代码经过验证可以直接拿去修改调用</p>
<p>Owner <code>breakEval13</code></p>
<p>https://github.com/breakEval13</p>

<footer>
Power By Gemini TextGenerate 2024-09-16
</footer>
</body>
</html>