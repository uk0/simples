<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>docker swarm 集成 Spring Cloud 验证</title>
  <meta name="description" content="docekr swarm spring cloud 验证" />
  <meta name="keywords" content="swarm" />
  <style>
    body {
      max-width: 820px;
      margin: 0 auto;
      padding: 20px;
      font-family: sans-serif;
      background-color: #fff;
      transition: background-color 0.3s ease;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
      color: #333;
    }
    h1 {
      font-size: 20px;
    }
    h2 {
      font-size: 18px;
    }
    h3 {
      font-size: 16px;
    }
    h4 {
      font-size: 14px;
    }
    h5 {
      font-size: 12px;
    }
    h6 {
      font-size: 11px;
    }
    pre {
      background-color: #eee;
      padding: 10px;
      border-radius: 5px;
      overflow-x: auto;
    }
    code {
      font-family: monospace;
      background-color: #f0f0f0;
      padding: 2px 5px;
      border-radius: 3px;
    }
    .highlight {
      background-color: #f0f0f0;
      padding: 10px;
      border-radius: 5px;
      overflow-x: auto;
    }
    .highlight pre {
      background-color: transparent;
      padding: 0;
      margin: 0;
    }
    .highlight code {
      background-color: transparent;
      padding: 0;
      margin: 0;
    }
    footer {
      text-align: center;
      margin-top: 20px;
      font-size: 12px;
      color: #666;
    }
    .title {
      text-align: center;
    }
  </style>
</head>
<body>
  <h1 class="title">docker swarm 集成 Spring Cloud 验证</h1>
  <p style="text-align: center;">2018-04-23 10:18:14 +0800</p>

  <h2>开始</h2>
  <ul>
    <li>机器选择 Centos 7 4Gb内存</li>
    <li><code>systemctl stop firewalld</code></li>
    <li><code>systemctl disable firewalld</code></li>
    <li><code>yum install -y docker-io</code></li>
    <li><code>yum install -y vim</code></li>
    <li><code>systemctl start docker</code></li>
    <li><code>systemctl enable docker</code></li>
  </ul>

  <h2>docker swarm init</h2>
  <ul>
    <li>任意一台机器执行 <code>docker swarm init</code></li>
    <li>讲得到的 结果 <code>copy</code></li>
    <li>在其他两台机器上执行</li>
    <li>配置 docker swarm 的启动文件</li>
  </ul>

  <pre><code class="yaml">version: '3'
services:
  eureka1:
    image: registry.ap-northeast-1.aliyuncs.com/emos_prod/emos.register.test:latest
    networks:
      - springcloud-overlay
    ports:
      - "8098:8098"
    environment:
      - ADDITIONAL_EUREKA_SERVER_LIST=http://emos:emos@eureka2:8098/eureka/,http://emos:emos@eureka3:8098/eureka/
    tty: true
    command: ["bash","-i","bin/Entrypoint.sh","start"]
  eureka2:
    image: registry.ap-northeast-1.aliyuncs.com/emos_prod/emos.register.test:latest
    networks:
      - springcloud-overlay
    ports:
      - "8097:8098"
    environment:
      - ADDITIONAL_EUREKA_SERVER_LIST=http://emos:emos@eureka1:8098/eureka/,http://emos:emos@eureka3:8098/eureka/
    tty: true
    command: ["bash","-i","bin/Entrypoint.sh","start"]
  eureka3:
    image: registry.ap-northeast-1.aliyuncs.com/emos_prod/emos.register.test:latest
    networks:
      - springcloud-overlay
    ports:
      - "8096:8098"
    environment:
      - ADDITIONAL_EUREKA_SERVER_LIST=http://emos:emos@eureka1:8098/eureka/,http://emos:emos@eureka2:8098/eureka/
    tty: true
    command: ["bash","-i","bin/Entrypoint.sh","start"]


  emos-config:
    image: registry.ap-northeast-1.aliyuncs.com/emos_prod/emos.config.test:latest
    ports:
      - "8888"
    networks:
      - springcloud-overlay
    environment:
      - EUREKA_SERVER_ADDRESS=http://emos:emos@eureka1:8098/eureka/,http://emos:emos@eureka2:8098/eureka/,http://emos:emos@eureka3:8098/eureka/
    tty: true
    depends_on:
      - eureka1
      - eureka2
      - eureka3
    command: ["bash","-i","bin/Entrypoint.sh","start"]
  ths-account:
    image: registry.ap-northeast-1.aliyuncs.com/emos_prod/emos.account.test:latest
    ports:
      - "8006"
    networks:
      - springcloud-overlay
    depends_on:
      - eureka1
      - eureka2
      - eureka3
      - emos-config
    environment:
      - EUREKA_SERVER_ADDRESS=http://emos:emos@eureka1:8098/eureka/,http://emos:emos@eureka2:8098/eureka/,http://emos:emos@eureka3:8098/eureka/
    tty: true
    command: ["bash","-i","bin/Entrypoint.sh","start"]
  emos-gateway:
    image: registry.ap-northeast-1.aliyuncs.com/emos_prod/emos.gateway.test:latest
    ports:
      - "8002"
    networks:
      - springcloud-overlay
    depends_on:
      - eureka1
      - eureka2
      - eureka3
      - ths-account
      - emos-config
    environment:
      - EUREKA_SERVER_ADDRESS=http://emos:emos@eureka1:8098/eureka/,http://emos:emos@eureka2:8098/eureka/,http://emos:emos@eureka3:8098/eureka/
    tty: true
    command: ["bash","-i","bin/Entrypoint.sh","start"]
networks:
  springcloud-overlay:
    driver: overlay
</code></pre>

  <h2>注意启动顺序</h2>
  <pre><code class="bash">#可以拆开分开执行
docker stack deploy -c  emeos.yml demo
</code></pre>

  <h3>问题解析</h3>
  <ul>
    <li>其中spring-cloud</li>
  </ul>

  <pre><code class="yaml">spring:
  cloud:
    config:
      profile: ${config.profile:dev}
      discovery:
        enabled: true
        service-id: ${APPLICATION_CONFIG_NAME}
  application:
      name: ${APPLICATION_NAME}
security:
  basic:
    enabled: false
  user:
    name: emos #eureka 用户名
    password: emos #eureka 密码
eureka:
  client:
    serviceUrl:
      defaultZone: ${EUREKA_SERVER_ADDRESS}
  instance:
    status-page-url-path: /swagger-ui.html
    hostname: ${HOST_NAME}
management:
  security:
    enabled: false

</code></pre>
  <ul>
    <li><code>HOST_NAME</code> 是要用 <code>swarm</code> 启动的服务名来定义的例如：<code>ths-account</code></li>
    <li><code>EUREKA_SERVER_ADDRESS</code> 是高可用服务</li>
    <li><code>APPLICATION_NAME</code> 是当前的 <code>APPLICATION</code>的名字需要进行配置</li>
    <li><code>APPLICATION_CONFIG_NAME</code> 是<code>config</code>服务的<code>application</code>名称 有些服务需要配置此项</li>
    <li><code>以上可能不善于表达，仅仅是技术方向的实现验证时间：2018年4月23日</code></li>
  </ul>

  <p>转载请注明出处，本文采用 <a href="http://creativecommons.org/licenses/by-nc-nd/4.0/">CC4.0</a> 协议授权</p>
  <footer>
    Power By Gemini TextGenerate 2024-09-16
  </footer>
  <script>
    // 获取当前时间，并根据时间设置主题
    const currentTime = new Date();
    const isNight = currentTime.getHours() >= 19 || currentTime.getHours() < 6;
    if (isNight) {
      document.body.style.backgroundColor = '#222';
      document.body.style.color = '#eee';
    }

    // 随机种子
    const seed = 199602051111;
    let randomSeed = seed;

    // 随机数生成器
    function getRandomInt(max) {
      randomSeed = (randomSeed * 9301 + 49297) % 233280;
      return Math.floor(randomSeed / 233280 * max);
    }

    // Highlight.js 与 Prism.js 代码高亮
    document.addEventListener("DOMContentLoaded", function () {
      // 使用 Prism.js
      // Prism.highlightAll();

      // 使用 Highlight.js
      // 确保已经加载 Highlight.js 库
      // highlightAll() 函数必须在 Highlight.js 加载后执行
      hljs.highlightAll();
    });

    // JavaScript 交互效果
    const codeElements = document.querySelectorAll("code");
    codeElements.forEach(code => {
      code.addEventListener("click", () => {
        // 添加或移除代码块的类名
        code.classList.toggle("highlight");
      });
    });
  </script>
</body>
</html>