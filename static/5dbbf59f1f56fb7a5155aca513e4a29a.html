<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gitlab JC/CD 第二篇</title>
    <meta name="description" content="spring-cloud java cicd gitlab" />
    <meta name="keywords" content="spring git lab java" />
    <style>
        body {
            font-family: sans-serif;
            background-color: #f0f0f0;
            max-width: 820px;
            margin: 0 auto;
            padding: 20px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        h1 {
            font-size: 20px;
            text-align: center;
        }
        h2 {
            font-size: 18px;
        }
        h3 {
            font-size: 16px;
        }
        h4 {
            font-size: 14px;
        }
        h5 {
            font-size: 12px;
        }
        h6 {
            font-size: 11px;
        }
        pre {
            background-color: #f0f0f0;
            padding: 10px;
            overflow-x: auto;
            border-radius: 4px;
        }
        code {
            font-family: monospace;
            background-color: #e0e0e0;
            padding: 2px 4px;
            border-radius: 4px;
        }
        .hljs {
            background-color: #f0f0f0;
            padding: 10px;
            overflow-x: auto;
            border-radius: 4px;
            color: #333;
        }
        .hljs-comment {
            color: #999;
        }
        .hljs-keyword {
            color: #008000;
        }
        .hljs-string {
            color: #000080;
        }
        .hljs-number {
            color: #0000ff;
        }
        .hljs-title {
            color: #000000;
        }
        .hljs-tag {
            color: #000000;
        }
        .hljs-attr {
            color: #000000;
        }
        .hljs-selector-id {
            color: #000000;
        }
        .hljs-selector-class {
            color: #000000;
        }
        .hljs-selector-attr {
            color: #000000;
        }
        .hljs-selector-pseudo {
            color: #000000;
        }
        .hljs-literal {
            color: #000000;
        }
        .hljs-doctag {
            color: #000000;
        }
        .hljs-meta {
            color: #000000;
        }
        .hljs-meta-string {
            color: #000000;
        }
        .hljs-built_in {
            color: #000000;
        }
        .hljs-variable {
            color: #000000;
        }
        .hljs-template-variable {
            color: #000000;
        }
        .hljs-template-tag {
            color: #000000;
        }
        .hljs-type {
            color: #000000;
        }
        .hljs-params {
            color: #000000;
        }
        .hljs-function {
            color: #000000;
        }
        .hljs-class {
            color: #000000;
        }
        .hljs-symbol {
            color: #000000;
        }
        .hljs-bullet {
            color: #000000;
        }
        .hljs-link {
            color: #000000;
        }
        .hljs-regexp {
            color: #000000;
        }
        .hljs-emphasis {
            color: #000000;
        }
        .hljs-strong {
            color: #000000;
        }
        .hljs-quote {
            color: #000000;
        }
        .hljs-code {
            color: #000000;
        }
        .hljs-deletion {
            color: #000000;
        }
        .hljs-addition {
            color: #000000;
        }
        .hljs-section {
            color: #000000;
        }
        .hljs-name {
            color: #000000;
        }
        .hljs-attribute {
            color: #000000;
        }
        .hljs-hexcolor {
            color: #000000;
        }
        .hljs-entity {
            color: #000000;
        }
        .hljs-operator {
            color: #000000;
        }
        .hljs-error {
            color: #000000;
        }
        .hljs-underline {
            color: #000000;
        }
        .hljs-console {
            color: #000000;
        }
        footer {
            text-align: center;
            font-size: 12px;
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <h1>Gitlab JC/CD 第二篇</h1>
    <p>
        <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Gitlab JC/CD 第二篇</title>
<meta name="description" content="spring-cloud java cicd gitlab" />
<meta name="keywords" content="spring git lab java" />
    </p>
    <h2>just now</h2>
    <ul>
        <li>上个文章介绍了 如何配置Gitlab 的Runner，这次介绍如何将Runner 利用起来。</li>
        <li>创建一个`Java`项目，配置它的`gitlab-ci`文件.</li>
        <li>下面的这个`yaml`文件是用来配置从源码到 Jar/Tar的一个过程，在提交到另一个仓库的yaml</li>
        <li>还有另一个 `yaml` 是从 源码-->Jar／tar--> 镜像</li>
    </ul>
    <pre>
        <code>
<pre><code class="yaml"># cache 这个参数用于定义全局那些文件将被 cache 到下一个  stages
# 调试开启
before_script:
 - pwd
 - env
 ##
 ## Assuming you created the SSH_KNOWN_HOSTS variable, uncomment the
 ## follo wing two lines.
 ##
 - mkdir -p /root/.ssh/
 - chmod  700 /root/.ssh/
 - echo -e "StrictHostKeyChecking no \nUserKnownHostsFile /dev/null" > ~/.ssh/config
cache:
  key: $CI_PROJECT_NAME-$CI_COMMIT_REF_NAME-$CI_COMMIT_SHA
  paths:
    - build/
    - /data/repo
stages:
  - build-jar
  - build-release
  - build-dev
variables:
  DOCKER_DRIVER: overlay2
  MAVEN_OPTS: "-Dmaven.repo.local=/data/repo"
  CI_DEBUG_TRACE: "true"
build-Java:
  image: "registry.cn-hangzhou.aliyuncs.com/emos_prod/centos7-jdk8-maven3-git-1.8:latest"
  stage: build-jar
  script:
    - chmod u+x ./maven-build-all.sh
    - ./maven-build-all.sh
    - ls -a build/
  tags:
    - build_dev

release-jar-release:
  image: "registry.cn-hangzhou.aliyuncs.com/emos_prod/centos7-jdk8-maven3-git-1.8:latest"
  stage: build-release
  script:
    - git clone http://$GITLAB_USER:$GITLAB_PASS@ gitlab-cicd.com/release/build-space.git
    - cd build-space && rm -rf * && cp -r ../build/* .
    - git config --global user.name "root"
    - git config --global user.email "root@emos.com"
    - git add --all .
    - git commit -m "Gitlab CI Auto Builder master"
    - git push --force --quiet http://$GITLAB_USER:$GITLAB_PASS gitlab-cicd.com/release/build-space.git master:master
  tags:
    - build_dev
  only:
    - master

release-jar-dev:
  image: "registry.cn-hangzhou.aliyuncs.com/emos_prod/centos7-jdk8-maven3-git-1.8:latest"
  stage: build-dev
  script:
    - git clone http://$GITLAB_USER:$GITLAB_PASS@ gitlab-cicd.com/dev/build-space.git
    - cd build-space && rm -rf * && cp -r ../build/* .
    - git config user.name "root"
    - git config user.email "root@emos.com"
    - git add --all .
    - git commit -m "Gitlab CI Auto Builder dev"
    - git push --force --quiet http://$GITLAB_USER:$GITLAB_PASS@gitlab-cicd.com/dev/build-space.git dev:dev
  tags:
    - build_dev
  only:
    - dev
</code></pre>
        </code>
    </pre>
    <p>
        * 文件主要是为了给Gitlab中的某个项目绑定一个`Job`运行这个Job的就是我们在上次讲的在 `gitlab` `runner` 。
    </p>
    <h3>看一下目录结构</h3>
    <img src="http://112firshme11224.test.upcdn.net/demos/7382a109-79c5-41c3-91ba-fa5d946ac61f.png" alt="目录结构">
    <p>
        *  这个总体 配置很简单都是`yaml`文件规范， 主要还是项介绍一下里面的`cache`  cache 是做CICD避免不掉的东西，可以用来 将编译好的文件传送到下一个 `stage`   实现方式大概是 将你要`cache`的包 打成一个`zip`包,启动下一个`stage` 在进行`unzip`到当初的目录地址。
    </p>
    <p>
        *  在以上的配置中 `GITLAB_USER`,`GITLAB_PASS`
    </p>
    <img src="http://112firshme11224.test.upcdn.net/demos/66b3a3ce-0df4-4c69-8c43-f3738001aaa1.png" alt="环境变量设置">
    <p>
        * 设置运行的环境变量
    </p>
    <img src="http://112firshme11224.test.upcdn.net/demos/6c890392-8690-4384-bc57-ffc38f9cae86.png" alt="全局缓存">
    <p>
        *  推荐创建全局Cache 。
    </p>
    <p>
        转载请注明出处，本文采用 <a href="http://creativecommons.org/licenses/by-nc-nd/4.0/">CC4.0</a> 协议授权
    </p>
    <footer>
        Power By Gemini TextGenerate 2024-09-16 21:37:07
    </footer>
    <script>
        //  DlHighlight.js代码高亮
        hljs.highlightAll();

        //  随机种子
        const seed = 4538978253;
        Math.seedrandom(seed);

        //  获取当前时间判断是白天还是夜晚
        const currentHour = new Date().getHours();
        if (currentHour >= 19 || currentHour < 6) {
            document.body.style.backgroundColor = '#111';
            document.body.style.color = '#fff';
        } else {
            document.body.style.backgroundColor = '#f0f0f0';
            document.body.style.color = '#333';
        }
    </script>
</body>
</html>