<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gitlab JC/CD 第二篇</title>
    <meta name="description" content="spring-cloud java cicd gitlab">
    <meta name="keywords" content="spring git lab java">
    <style>
        body {
            font-family: sans-serif;
            background-color: #fff;
            color: #333;
            transition: background-color 0.3s ease;
            max-width: 820px;
            margin: 0 auto;
            padding: 20px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }
        
        h1 {
            font-size: 20px;
        }
        
        h2 {
            font-size: 18px;
        }
        
        h3 {
            font-size: 16px;
        }
        
        h4 {
            font-size: 14px;
        }
        
        h5 {
            font-size: 12px;
        }
        
        h6 {
            font-size: 11px;
        }
        
        pre {
            background-color: #f0f0f0;
            padding: 10px;
            border-radius: 5px;
            overflow-x: auto;
        }
        
        code {
            font-family: monospace;
            background-color: #eee;
            padding: 2px 5px;
            border-radius: 3px;
        }
        
        footer {
            text-align: center;
            margin-top: 20px;
            font-size: 12px;
            color: #666;
        }
        
        .title-container {
            text-align: center;
        }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/default.min.css">
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            Prism.highlightAll();
            hljs.highlightAll();
            const seed = 199602051111;
            const random = (max) => Math.floor(Math.random() * max) + 1;
            const hour = new Date().getHours();
            if (hour >= 18 || hour < 6) {
                document.body.style.backgroundColor = '#222';
                document.body.style.color = '#eee';
            }
            const codeElements = document.querySelectorAll('pre code');
            codeElements.forEach(code => {
                code.addEventListener('click', () => {
                    const randomColor = `#${random(255).toString(16).padStart(2, '0')}${random(255).toString(16).padStart(2, '0')}${random(255).toString(16).padStart(2, '0')}`;
                    code.style.backgroundColor = randomColor;
                });
            });
        });
    </script>
</head>
<body>
    <div class="title-container">
        <h1>Gitlab JC/CD 第二篇</h1>
        <p>spring-cloud java cicd gitlab</p>
    </div>
    <h2>just now</h2>
    <ul>
        <li>上个文章介绍了 如何配置Gitlab 的Runner，这次介绍如何将Runner 利用起来。</li>
        <li>创建一个<code>Java</code>项目，配置它的<code>gitlab-ci</code>文件.</li>
        <li>下面的这个<code>yaml</code>文件是用来配置从源码到 Jar/Tar的一个过程，在提交到另一个仓库的yaml</li>
        <li>还有另一个 <code>yaml</code> 是从 源码-->Jar／tar--> 镜像</li>
    </ul>
    <pre><code class="language-yaml"># cache 这个参数用于定义全局那些文件将被 cache 到下一个  stages
# 调试开启
before_script:
 - pwd
 - env
 ##
 ## Assuming you created the SSH_KNOWN_HOSTS variable, uncomment the
 ## follo wing two lines.
 ##
 - mkdir -p /root/.ssh/
 - chmod  700 /root/.ssh/
 - echo -e "StrictHostKeyChecking no \nUserKnownHostsFile /dev/null" > ~/.ssh/config
cache:
  key: $CI_PROJECT_NAME-$CI_COMMIT_REF_NAME-$CI_COMMIT_SHA
  paths:
    - build/
    - /data/repo
stages:
  - build-jar
  - build-release
  - build-dev
variables:
  DOCKER_DRIVER: overlay2
  MAVEN_OPTS: "-Dmaven.repo.local=/data/repo"
  CI_DEBUG_TRACE: "true"
build-Java:
  image: "registry.cn-hangzhou.aliyuncs.com/emos_prod/centos7-jdk8-maven3-git-1.8:latest"
  stage: build-jar
  script:
    - chmod u+x ./maven-build-all.sh
    - ./maven-build-all.sh
    - ls -a build/
  tags:
    - build_dev

release-jar-release:
  image: "registry.cn-hangzhou.aliyuncs.com/emos_prod/centos7-jdk8-maven3-git-1.8:latest"
  stage: build-release
  script:
    - git clone http://$GITLAB_USER:$GITLAB_PASS@ gitlab-cicd.com/release/build-space.git
    - cd build-space && rm -rf * && cp -r ../build/* .
    - git config --global user.name "root"
    - git config --global user.email "root@emos.com"
    - git add --all .
    - git commit -m "Gitlab CI Auto Builder master"
    - git push --force --quiet http://$GITLAB_USER:$GITLAB_PASS gitlab-cicd.com/release/build-space.git master:master
  tags:
    - build_dev
  only:
    - master

release-jar-dev:
  image: "registry.cn-hangzhou.aliyuncs.com/emos_prod/centos7-jdk8-maven3-git-1.8:latest"
  stage: build-dev
  script:
    - git clone http://$GITLAB_USER:$GITLAB_PASS@ gitlab-cicd.com/dev/build-space.git
    - cd build-space && rm -rf * && cp -r ../build/* .
    - git config user.name "root"
    - git config user.email "root@emos.com"
    - git add --all .
    - git commit -m "Gitlab CI Auto Builder dev"
    - git push --force --quiet http://$GITLAB_USER:$GITLAB_PASS@gitlab-cicd.com/dev/build-space.git dev:dev
  tags:
    - build_dev
  only:
    - dev
</code></pre>
    <p>文件主要是为了给Gitlab中的某个项目绑定一个<code>Job</code>运行这个Job的就是我们在上次讲的在 <code>gitlab</code> <code>runner</code> 。</p>
    <h3>看一下目录结构</h3>
    <img src="http://112firshme11224.test.upcdn.net/demos/7382a109-79c5-41c3-91ba-fa5d946ac61f.png" alt="目录结构">
    <p>这个总体 配置很简单都是<code>yaml</code>文件规范， 主要还是项介绍一下里面的<code>cache</code>  cache 是做CICD避免不掉的东西，可以用来 将编译好的文件传送到下一个 <code>stage</code>   实现方式大概是 将你要<code>cache</code>的包 打成一个<code>zip</code>包,启动下一个<code>stage</code> 在进行<code>unzip</code>到当初的目录地址。</p>
    <p>在以上的配置中 <code>GITLAB_USER</code>,<code>GITLAB_PASS</code></p>
    <img src="http://112firshme11224.test.upcdn.net/demos/66b3a3ce-0df4-4c69-8c43-f3738001aaa1.png" alt="环境变量设置">
    <p>设置运行的环境变量</p>
    <img src="http://112firshme11224.test.upcdn.net/demos/6c890392-8690-4384-bc57-ffc38f9cae86.png" alt="全局Cache">
    <p>推荐创建全局Cache 。</p>
    <footer>
        Power By Gemini TextGenerate 2024-09-16
    </footer>
</body>
</html>