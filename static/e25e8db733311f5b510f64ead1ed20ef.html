<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>python 远程启动mapreduce作业</title>
    <meta name="description" content="python 模拟实现tail -f">
    <meta name="keywords" content="python">
    <style>
        body {
            font-family: sans-serif;
            background-color: #f5f5f5;
            color: #333;
            max-width: 820px;
            margin: 0 auto;
            padding: 20px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            transition: background-color 0.3s ease;
        }
        
        h1 {
            font-size: 20px;
            text-align: center;
            margin-bottom: 20px;
        }
        
        h2 {
            font-size: 18px;
            margin-bottom: 15px;
        }
        
        h3 {
            font-size: 16px;
            margin-bottom: 10px;
        }
        
        h4 {
            font-size: 14px;
            margin-bottom: 8px;
        }
        
        h5 {
            font-size: 12px;
            margin-bottom: 6px;
        }
        
        h6 {
            font-size: 11px;
            margin-bottom: 4px;
        }
        
        pre {
            background-color: #f5f5f5;
            border: 1px solid #ccc;
            padding: 10px;
            overflow-x: auto;
        }
        
        code {
            font-family: Consolas, Monaco, monospace;
            background-color: #f5f5f5;
            color: #333;
        }
        
        footer {
            text-align: center;
            margin-top: 20px;
            font-size: 12px;
            color: #999;
        }
        
        .night-mode {
            background-color: #222;
            color: #eee;
        }
        
        .night-mode code {
            background-color: #333;
            color: #eee;
        }
    </style>
</head>
<body>
    <h1>python 远程启动mapreduce作业</h1>
    <p style="text-align: center;">本文基于Python2.7  进行测试</p>
    <h2>源码</h2>
    <pre><code class="language-python">
# -*- coding:utf-8 -*-
import BaseHTTPServer
import threading
import logging
import time
import urllib
import urlparse
import shlex
import subprocess
import io, shutil
import re
import random
import time
import os
from multiprocessing import Queue, Pool
import multiprocessing, time, random
class RequestHandler(BaseHTTPServer.BaseHTTPRequestHandler):
    '''处理请求并返回页面'''

    def do_GET(s):
        try:
            if None != re.search('/api/v1/startjar*', s.path) and '?' in s.path:
                print("in controller")
                content = ""
                startjar = ""
                query = urllib.splitquery(s.path)
                action = query[0]
                if query[1]:  # 接收get参数
                    queryParams = {}
                    for qp in query[1].split('&'):
                        kv = qp.split('=')
                        queryParams[kv[0]] = urllib.unquote(kv[1]).decode("utf-8", 'ignore')
                        content += kv[0] + ':' + queryParams[kv[0]] + "\r\n"
                        if kv[0] == 'jar':
                            startjar = queryParams[kv[0]]

                shell_cmd = ' hadoop fs -copyToLocal /task/mr/'+startjar+' /opt/cm/lib/cloudera-scm-agent/jobs/myjar.jar && hadoop jar /opt/cm/lib/cloudera-scm-agent/jobs/myjar.jar && yes|rm /opt/cm/lib/cloudera-scm-agent/jobs/myjar.jar'
                print("cmd is " + shell_cmd)
                cmd = shlex.split(shell_cmd)
                p = subprocess.Popen(cmd, shell=False, stdout=subprocess.PIPE, stderr=subprocess.STDOUT)
                while p.poll() is None:
                    line = p.stdout.readline()
                    line = line.strip()
                    if line:
                        s.wfile.write(line + "\n")
                if p.returncode == 0:
                    print('Subprogram success')
                else:
                    print('Subprogram failed')
        except Exception:
            s.wfile.close()
            print("Error ")


# ---------------------------------------------------------------------

if __name__ == '__main__':
    serverAddress = ('', 8881)
    server = BaseHTTPServer.HTTPServer(serverAddress, RequestHandler)
    server.serve_forever()

</code></pre>
    <h2>python 远程执行作业，（作业通过serverless 上传到hdfs）</h2>
    <ul>
        <li>用的http服务是python2.7 自带的 （简单）</li>
        <li>实现比较简单就是利用了 subprocess 的PIPE 通过管道将结果输出，实现一个watch on 的效果（ 大佬勿喷）</li>
    </ul>
    <h2>补充 serverless 上传jar的代码</h2>
    <ul>
        <li>注意 kubeless 1.0.0版本 Python 的runtime是基于`bottle`还是可以 做点手脚的。</li>
    </ul>
    <pre><code class="language-python">
# /usr/bin/env python
# coding=utf-8

import paramiko
import os
from hdfs import Client
from bottle import route, run
from bottle import request

client = Client("http://hdfs-web-svc.cloudera:50070", root="/", timeout=100, session=False)
# 文件上传的HTML模板，这里没有额外去写html模板了，直接写在这里，方便点吧
@route('/upload')
def upload():
    return '''
        <html>
            <head>
            </head>
            <body>
                <form action"/upload" method="post" enctype="multipart/form-data">
                    <input type="file" name="data" />
                    <input type="submit" value="Upload" />
                </form>
            </body>
        </html>
    '''
# 文件上传，overwrite=True为覆盖原有的文件，
# 如果不加这参数，当服务器已存在同名文件时，将返回“IOError: File exists.”错误
@route('/upload', method='POST')
def doupload():
    upload = request.files.getall('data')
    for meta in upload:
        buf = meta.file.read()
        name, ext = os.path.splitext(meta.filename)
        if ext not in ('.jar', '.tar'):
            return 'File extension not allowed. type [JAR]'
        path = '/task/mr/' + name + ext
        # ssh root@agent-2.agent-svc.cloudera.svc.cluster.local
        print("--------------save Task To" + path)
        with client.write(path, overwrite=True) as writer:
            writer.write(buf);
    return 'ok'

</code></pre>
    <footer>
        Power By Gemini TextGenerate 2024-09-16
    </footer>
    <script>
        // 获取当前时间
        var now = new Date();
        var hour = now.getHours();
        
        // 判断是否为夜间模式
        if (hour >= 18 || hour < 6) {
            document.body.classList.add('night-mode');
        }

        // 初始化 Highlight.js 或 Prism.js
        hljs.initHighlightingOnLoad(); // 假设你已经包含了 Highlight.js 库
        // 或者使用 Prism.js
        // Prism.highlightAll();
    </script>
</body>
</html>