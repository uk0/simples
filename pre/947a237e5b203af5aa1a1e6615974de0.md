# Nginx 做为前端负载均衡时，后端服务器获取的 IP 为 Nginx 的本机 IP ，让 Nginx 把用户 IP 传递到后端里面去。  
  
## 问题  
  
Nginx 做为前端负载均衡时，后端服务器获取的IP为 Nginx 的本机IP.  
  
## 解决办法  
  
```  
  
1. Nginx 开启 http\_realip\_module 模块  
  
./configure --with-http\_realip\_module  
  
make && make install  
  
2. Nginx 前端 增加 proxy\_set\_header  
  
proxy\_set\_header X-Real-IP $remote\_addr;  
  
3. Nginx 后端 增加 real\_ip\_header  
  
real\_ip\_header X-Real-IP;  
  
后端配置 必须重启 Nginx 才能生效， reload 不生效。  
  
4. Tomcat 后端 需要修改 Service.xml  
  
找到  
  
pattern="%h %l %u %t &ampquot%r&ampquot %s %b" />  
  
修改为  
  
pattern="%{X-FORWARDED-FOR}i %l %u %t %r %s %b %D %q %{User-Agent}i %T" resolveHosts=&quotfalse"/>  
  
```